 Установка  
======

1. Выполнить следущие команды:
	```
	pip install djangorestframework
	pip install django-cors-headers
	pip install pycrypto
	pip install django-silk
	```
2. `serv/serv/settings.py` добавить к ALLOWED_HOSTS ip своего компьютера (смотри ifconfig)
3. Запуск `python manage.py runserver <ip:port>`


# Authenfication

В этой версии проекта используется двуступенчатая аутенфикация, единая для всех типов пользователей.
### Первая ступень - получение токена
На `<ip>:<port>/api/startauthsession/` нужно отправить POST запрос, в котором необходимо передать **username** пользователя. Ответом придет пара хэшей - **salt** и **token**.
### Вторая ступень - получение доступа
Пароль прежде всего нудно посолить: `saltedPassword = sha256(password+salt)`
На `<ip>:<port>/api/startauthsession/` нужно отправить POST запрос, в котором необходимо передать **saltedPassword**  и **token**.

### Ошибки при аутенфикации:

> **1 ступень:**   
> 404 - Не существует пользователя с таким username 2  
> **2 ступень:**   
> 403 - Неправильный пароль    
> 401 - Протухший токен  
> 	404 - Нет такого токена  

# Register
Мы предполагаем, что пользователь либо уже купил наш жетон, либо еще нет. Поэтому существуют два типа регистрации
Если пользователь уже купил жетон, то он будет иметь код подтверждения, чтобы зарегистрировать свой жетон в системе.
### Type 1, с жетоном
1. GET запрос на `<ip>:<port>/api/register/`, чтобы получить **salt**
2. POST запрос на `<ip>:<port>/api/register/` с объектами **usr**, **rec**, **mrd**, которые описаны в разделе *Основные интерфейсы и объекты*
### Type 2, без жетона
1. GET запрос на `<ip>:<port>/api/register/`, чтобы получить **salt**
2. POST запрос на `<ip>:<port>/api/register/` с объектами **usr**, **rec**, которые описаны в разделе *Основные интерфейсы и объекты*
### Ошибки при регистрации

> 412 - Не существует жетона, который пытаются зарегистрировать или он уже занят  
> 403 - Неправильный код подтверждения  
> 400 - Неправильный формат данных  

# Editor
### Для пользователя
PUT запрос на `<ip>:<port>/api/editor/` два объекта **usr** и **rec** только с полями, требующими замены.
Исключениями являются следующие поля объекта **rec**:
 1. illnesses
 2. contacts
 3. hospitals
 4. recipes
 5. children
!!! Эти поля являются массивами и хранятся в формате JSON строки в БД. При добавлении и/или изменении любого элемента массива, необходимо отправлять весь массив.
### Для мед. персонала  
PUT запрос на `<ip>:<port>/api/doctor/`
состоящий из:
```
token: String, // токен врача
id: String, // MRecord ID пациента
res: Object // объект в котором есть только измененные поля
```



### Ошибки при редактировании
> 404 - Неправильный токен  
> 400 - Ошибка в формате передаваемых данных  
> 401 - Протухший токен  

# Octopus
GET запрос на `<ip>:<port>/api/octopus/<token>/<meta>/`, где *token* - токен ОТПРАВИТЕЛЯ, *meta* - информация о формате ответа.
META может быть следующей:
 1. **r**- информация пользователя о самом себе, возвращает **usr** и **rec**
 2. **m** - информация модератора о самом себе, возвращает **usr**, **hos**, **doc**
 3.  **d** - информация доктора о самом себе, возвращает **usr** и **doc**
 4. **rd** - информация о пользователе по MRecordID для врача, возвращает **usr** и **rec**
 5. **ra** - информация о пользователе по MRecordID для СМП, возвращает **usr** и **rec**
 6. **octopus/getrecord/** - информация о пользователе для пользователя, не требует токена!!!, возвращает **codes**
 
 Подробную информацию о возвращаемых объектах смотри в разделе *Основные интерфейсы и объекты*
Для отправки MRecordID используйте параметр id:
`<ip>:<port>/api/octopus/<token>/<rd или ra>/?id=123456/`

### Ошибки
 
 > 404 - Неправильный токен  
 > 401 - Протухший токен  
 > 400 - Нет meta  
 > 403 - Нет доступа, запрещен доступ  
 > 418 - Пользователь не найден - в rd, ra, getrecord  

# Основные интерфейсы и объекты

### Информация о пользователе
Поля, помеченные *, не отправляются с сервера вместе с остальными данными или вообще никогда. Их нужно запоминать при авторизации или изменении  

Поля, помеченные **, требуют  дополнительного парсинга из JSON строки в массив
```
usr = {
    *'username'   :  String,
    *'password'   :  String,
    'last_name'   :  String,
    'first_name'  :  String,
    'second_name' :  String,
    'email'       :  String,
    *'salt'       :  String,
}
 ```
```
rec = {
	'serial_number'    :  String,
	'insurance_number' :  String,
	'blood_type'       :  String,
	**'illnesses'      :  Array,
	**'contacts'       :  Array,
	**'hospitals'      :  Array,
	**'recipes'        :  Array,
	**'children'       :  Array,
}
```
```
mrd = {
    'id'   : String, // serial_number чипа
    'code' : String, // код подтверждения чипа
}
```

#### Примеры массивов, входящих в *rec*

```
illnesses = {
    'info' : String, // название болезни
    'code' : String, // код болезни по МКБ-10
    'start_date' : String, // дата диагностирования болезни
}
```

```
children = {
    'name' : String, // имя ребенка
    'serial_number' : String, // номер жетона ребенка 
}
```

```
hospitals = {
    'address' : String, // адресс госпиталя
    'date' : String, // дата приема
    'doctor' : String, // доктор, который вел прием
    'result' : String, // результат, к которому пришли во время приема
}
```

```
recipes = {
    'name' : String, // название препаратаб
    'info' : String, // бозень от которой он назначен (название)
    'code' : String, // бозень от которой он назначен (код по МКБ-10)
    'start_date' : String, // дата начала курса
    'end_date' : (optional) String // дата конца курса 
}
```

```
contacts = {
    'name' : String, // имя близкого/родного
    'number' : String, // номер телефона близкого/родного
}
```

### Информация о госпитале, единая для всех
```
hos = {
	'id' : Int,
	'address': {
		'region'     : String,
		'country'    : String,
		'city'       : String,
		'street'     : String,
		'geo_data'   : String, // Информация о долготе и широте
		'post_index' : String, // Почтовый индекс
	},
	'name' : String, // Название госпиталя
	'additional': (optional) String,// Дополнительные сведения, например, спецификация госпиталя
}
```

### Информация для модераторов
```
doc = Array of doc (тот же doc, что  и ниже, только без информации о госпитале)
```
### Информация для докторов
```
doc = {
	'usr' : <User Object>,
	'hos' : <Hospital Object>,
	'code' : String, // "печать" доктора, по которой можно легко найти его в базе
}
```
### Информация для пользователей о пользователях
```
codes :Array[String]
```
**список будет дополняться**